using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using CapaEntidades;
using CapaNegocio;
using CapaPresentacion;
using Microsoft.Reporting.WinForms;
using System.Data.SqlClient;
using System.Configuration;

namespace CapaPresentacion
{

    public partial class FrmProductos : Form
    {
        private CategoriaBL bl = new CategoriaBL();
        private ProductoBL productoBL = new ProductoBL();
        private BindingList<Productos> listaProductos = new BindingList<Productos>();
        private BindingSource productosBinding = new BindingSource();
        private int idSeleccionado = 0;
        private bool ValidarCampos()
        {
            if (cmbProductos.SelectedIndex == -1)
            {
                MessageBox.Show("El producto es obligatorio.", "Validación", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                cmbProductos.Focus();
                return false;
            }

            if (string.IsNullOrWhiteSpace(txtPrecio.Text))
            {
                MessageBox.Show("El precio del Producto es obligatoria.", "Validación", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtPrecio.Focus();
                return false;
            }

            if (string.IsNullOrWhiteSpace(textBox1.Text))
            {
                MessageBox.Show("El stock del Producto es obligatorio.", "Validación", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                textBox1.Focus();
                return false;
            }
            else if (!int.TryParse(textBox1.Text, out _))
            {
                MessageBox.Show("El stock debe ser un número entero.", "Validación", MessageBoxButtons.OK, MessageBoxIcon.Warning); 
                textBox1.Focus();
                return false;
            }

            if (string.IsNullOrWhiteSpace(comboBox1.Text))
            {
                MessageBox.Show("La categoria del Producto es obligatorio.", "Validación", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                comboBox1.Focus();
                return false;
            }

            return true;
        }

        public FrmProductos()
        {
            InitializeComponent();

            // Configurar binding del DataGridView
            productosBinding.DataSource = listaProductos;
            dgvProductos.AutoGenerateColumns = true;
            dgvProductos.DataSource = productosBinding;
        }

        private void Listarp()
        {
            listaProductos.Clear();
            var productos = productoBL.Listar();
            if (productos != null)
            {
                foreach (var producto in productos)
                {
                    // Convertir Producto a Productos
                    var prod = new Productos
                    {
                        id_productos = producto.id_productos,
                        nombre_producto = producto.nombre_producto,
                        precio_producto = producto.precio_producto,
                        stock = producto.stock,
                        id_categoria = producto.id_categoria,
                        estado = producto.estado
                    };
                    listaProductos.Add(prod);
                }
            }
            HideSensitiveColumns(dgvProductos);
        }

        private void btnAgregar_Click(object sender, EventArgs e)
        {
            if (comboBox1.SelectedValue == null)
            {
                MessageBox.Show("Debe seleccionar una categoría.");
                return;
            }

            if (ValidarCampos())
            {
                // Obtener el producto seleccionado del combobox
                if (cmbProductos.SelectedIndex == -1)
                {
                    MessageBox.Show("Debe seleccionar un producto.");
                    return;
                }

                int idProductoSeleccionado = Convert.ToInt32(cmbProductos.SelectedValue);

                Productos producto = new Productos
                {
                    Id_Productos = idProductoSeleccionado,
                    Nombre_Producto = cmbProductos.Text,
                    Precio_Producto = decimal.TryParse(txtPrecio.Text, out decimal precio) ? precio : 0,
                    Stock = int.TryParse(textBox1.Text, out int stock) ? stock : 0,
                    Estado = 1,
                    Id_Categoria = comboBox1.SelectedValue != null ? Convert.ToInt32(comboBox1.SelectedValue) : 0
                };

                // Guardar producto
                ProductoBL productoBL = new ProductoBL();
                productoBL.Agregar(producto);

                // Refrescar DataGrid
                Listarp();
                productosBinding.ResetBindings(false);

                // Mensaje de confirmación
                MessageBox.Show("Producto guardado correctamente.", "Éxito", MessageBoxButtons.OK, MessageBoxIcon.Information);

                // Limpiar campos
                Limpiar();
            }
        }

        private void dgvProductos_CellClick(object sender, DataGridViewCellEventArgs e)
        {
            if (dgvProductos.CurrentRow?.DataBoundItem is Productos prod)
            {
                idSeleccionado = prod.Id_Productos;

                // Actualizar cmbProductos con el producto seleccionado
                cmbProductos.SelectedValue = prod.Id_Productos;
                txtPrecio.Text = prod.Precio_Producto.ToString();
                textBox1.Text = prod.Stock.ToString();

                // Asignar la categoría al combobox usando Id_Categoria (ValueMember).
                try
                {
                    comboBox1.SelectedValue = prod.Id_Categoria;
                }
                catch
                {
                    comboBox1.SelectedIndex = -1;
                }

                // Sincronizar txtStock
                txtStock.Text = prod.Stock.ToString();
                var txtStockCtrl = this.Controls.Find("txtStock", true).FirstOrDefault() as TextBox;
                if (txtStockCtrl != null) txtStockCtrl.Text = prod.Stock.ToString();

                FillEliminarControls(prod);
            }
        }

        private void FillEliminarControls(Producto prod)
        {
            if (prod == null) return;

            
            Action<string, string> SetText = (name, value) =>
            {
                var ctrl = this.Controls.Find(name, true).FirstOrDefault();
                if (ctrl is TextBox tb) tb.Text = value;
                else if (ctrl is Label lbl) lbl.Text = value;
            };

            SetText("txtIdEliminar", prod.Id_Productos.ToString());
            SetText("lblIdEliminar", prod.Id_Productos.ToString());

            SetText("txtNombreEliminar", prod.Nombre_Producto ?? string.Empty);
            SetText("lblNombreEliminar", prod.Nombre_Producto ?? string.Empty);

            SetText("txtPrecioEliminar", prod.Precio_Producto.ToString());
            SetText("lblPrecioEliminar", prod.Precio_Producto.ToString());

            SetText("txtStockEliminar", prod.Stock.ToString());
            SetText("lblStockEliminar", prod.Stock.ToString());

            var cbEliminar = this.Controls.Find("comboBoxEliminar", true).FirstOrDefault() as ComboBox;
            if (cbEliminar != null)
            {
                try { cbEliminar.SelectedValue = prod.Id_Categoria; } catch { }
            }
            else
            {
                SetText("lblCategoriaEliminar", prod.Id_Categoria.ToString());
                SetText("txtCategoriaEliminar", prod.Id_Categoria.ToString());
            }
        }

        private void btnEliminar_Click(object sender, EventArgs e)
        {
            if (dgvProductos.SelectedRows.Count > 0)
            {
                // MENSAJE DE ALERTA ANTES DE ELIMINAR
                DialogResult result = MessageBox.Show("¿Está seguro de que desea desactivar este Producto?",
                    "Atención", MessageBoxButtons.YesNo, MessageBoxIcon.Warning);

                if (result == DialogResult.Yes)
                {
                    int Id;
                    if (!int.TryParse(Convert.ToString(dgvProductos.CurrentRow.Cells["Id_Productos"].Value), out Id) || Id <= 0)
                    {
                        MessageBox.Show("Id de producto inválido.");
                        return;
                    }

                    var producto = new Productos { Id_Productos = Id };
                    productoBL.Eliminar(producto);

                    MessageBox.Show("Producto eliminado");
                    Listarp();
                    productosBinding.ResetBindings(false);
                    Limpiar();
                }
            }
            else
            {
                MessageBox.Show("Seleccione un registro de la tabla.");
            }
        }

        private void Limpiar()
        {
            idSeleccionado = 0;
            cmbProductos.SelectedIndex = -1;
            txtStock.Clear();
            txtPrecio.Clear();
            comboBox1.SelectedIndex = -1;
            textBox1.Clear();

            Action<string> ClearIfExists = (name) =>
            {
                var ctrl = this.Controls.Find(name, true).FirstOrDefault();
                if (ctrl is TextBox tb) tb.Clear();
                else if (ctrl is Label lbl) lbl.Text = string.Empty;
            };

            ClearIfExists("txtIdEliminar");
            ClearIfExists("lblIdEliminar");
            ClearIfExists("txtNombreEliminar");
            ClearIfExists("lblNombreEliminar");
            ClearIfExists("txtPrecioEliminar");
            ClearIfExists("lblPrecioEliminar");
            ClearIfExists("txtStockEliminar");
            ClearIfExists("lblStockEliminar");
            ClearIfExists("lblCategoriaEliminar");
            ClearIfExists("txtCategoriaEliminar");
        }

        private void FrmProductos_Load(object sender, EventArgs e)
        {
            CargarCategorias();
            CargarProductosEnComboBoxes();
            Listarp();
            HideSensitiveColumns(dgvProductos);
        }

        private void CargarProductosEnComboBoxes()
        {
            try
            {
                var productos = productoBL.Listar();
                if (productos != null)
                {
                    List<Productos> listaProductosCombo = new List<Productos>();
                    foreach (var producto in productos)
                    {
                        listaProductosCombo.Add(new Productos
                        {
                            id_productos = producto.id_productos,
                            nombre_producto = producto.nombre_producto,
                            precio_producto = producto.precio_producto,
                            stock = producto.stock,
                            id_categoria = producto.id_categoria,
                            estado = producto.estado
                        });
                    }

                    // Configurar cmbProductos (en groupBox1)
                    cmbProductos.DataSource = listaProductosCombo;
                    cmbProductos.DisplayMember = "nombre_producto";
                    cmbProductos.ValueMember = "id_productos";
                }
            }
            catch
            {
                // ignorar si falla al cargar productos
            }
        }

        private void CargarCategorias()
        {
            try
            {
                comboBox1.DataSource = bl.Listar();
                comboBox1.DisplayMember = "Nombre_Categoria";
                comboBox1.ValueMember = "Id_Categoria";
            }
            catch
            {
                // ignorar si falla al cargar categorías
            }
        }

        private void HideSensitiveColumns(DataGridView dgv)
        {
            if (dgv?.Columns == null) return;
            try
            {
                // Ocultar todas las variantes de ID
                string[] columnasOcultas = { "Id_Productos", "id_productos", "ID_Productos", "IDProductos",
                                           "Id_Categoria", "id_categoria", "ID_Categoria", "IDCategoria",
                                           "Estado", "estado", "ESTADO", "Nombre_Producto", "nombre_producto" };

                foreach (var columnaOculta in columnasOcultas)
                {
                    if (dgv.Columns.Contains(columnaOculta))
                        dgv.Columns[columnaOculta].Visible = false;
                }
            }
            catch
            {
                // no interrumpir si falla al ocultar columnas
            }
        }

        private void groupBox1_Enter(object sender, EventArgs e)
        {

        }

        private void label1_Click(object sender, EventArgs e)
        {

        }

        private void dgvProductos_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {

        }

        private void txtNombre2_TextChanged(object sender, EventArgs e)
        {

        }

        private void label4_Click(object sender, EventArgs e)
        {

        }

        private void textBox1_TextChanged(object sender, EventArgs e)
        {

        }

        private void button1_Click(object sender, EventArgs e)
        {
        
        }

        private void textBox1_TextChanged_1(object sender, EventArgs e)
        {

        }

        private void fillByToolStripButton_Click(object sender, EventArgs e)
        {

        }

        private void fillByToolStrip_ItemClicked(object sender, ToolStripItemClickedEventArgs e)
        {

        }

        private void button4_Click(object sender, EventArgs e)
        {

            FormInformProduct formInformProduct = new FormInformProduct();
            formInformProduct.ShowDialog();
        }

        private void label5_Click(object sender, EventArgs e)
        {

        }

        private void comboBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            // Filtrar productos por la categoría seleccionada
            if (comboBox1.SelectedValue != null && int.TryParse(comboBox1.SelectedValue.ToString(), out int idCategoriaSeleccionada))
            {
                listaProductos.Clear();
                var productos = productoBL.Listar();

                if (productos != null)
                {
                    foreach (var producto in productos)
                    {
                        // Solo agregar productos de la categoría seleccionada
                        if (producto.id_categoria == idCategoriaSeleccionada)
                        {
                            var prod = new Productos
                            {
                                id_productos = producto.id_productos,
                                nombre_producto = producto.nombre_producto,
                                precio_producto = producto.precio_producto,
                                stock = producto.stock,
                                id_categoria = producto.id_categoria,
                                estado = producto.estado
                            };
                            listaProductos.Add(prod);
                        }
                    }
                }
            }
        }

        private void btnLimpiar_Click(object sender, EventArgs e)
        {
            Limpiar();
        }

        private void dataSet1BindingSource_CurrentChanged(object sender, EventArgs e)
        {

        }

        private void reportViewer1_Load(object sender, EventArgs e)
        {
            
        }

        private void reportViewer2_Load(object sender, EventArgs e)
        {

        }

        private void cmbProductos_SelectedIndexChanged(object sender, EventArgs e)
        {
            // Cuando se selecciona un producto en el combobox de groupBox1
            if (cmbProductos.SelectedIndex != -1 && cmbProductos.SelectedItem is Productos prod)
            {
                // Llenar automáticamente precio y stock
                txtPrecio.Text = prod.Precio_Producto.ToString();
                textBox1.Text = prod.Stock.ToString();
            }
        }

        private void cmbProductosSeleccionar_SelectedIndexChanged(object sender, EventArgs e)
        {
            // Cuando se selecciona un producto en el combobox de groupBox2 (eliminar)
            if (cmbProductosSeleccionar.SelectedIndex != -1 && cmbProductosSeleccionar.SelectedItem is Productos prod)
            {
                idSeleccionado = prod.Id_Productos;

                // Llenar datos en la sección de eliminación
                Action<string, string> SetText = (name, value) =>
                {
                    var ctrl = this.Controls.Find(name, true).FirstOrDefault();
                    if (ctrl is TextBox tb) tb.Text = value;
                    else if (ctrl is Label lbl) lbl.Text = value;
                };

                SetText("txtIdEliminar", prod.Id_Productos.ToString());
                SetText("lblIdEliminar", prod.Id_Productos.ToString());
                SetText("txtNombreEliminar", prod.Nombre_Producto ?? string.Empty);
                SetText("lblNombreEliminar", prod.Nombre_Producto ?? string.Empty);
                SetText("txtPrecioEliminar", prod.Precio_Producto.ToString());
                SetText("lblPrecioEliminar", prod.Precio_Producto.ToString());
                SetText("txtStockEliminar", prod.Stock.ToString());
                SetText("lblStockEliminar", prod.Stock.ToString());
            }
        }
    }
}