using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using CapaNegocio;
using CapaEntidades;

namespace CapaPresentacion
{
    public partial class FormFacturacion : Form
    {
        private DetalleVentaBL detalleVentaBL = new DetalleVentaBL();
        private ClienteBL clienteBL = new ClienteBL();
        private CategoriaBL categoriaBL = new CategoriaBL();
        private ProductoBL productoBL = new ProductoBL();

        public FormFacturacion()
        {
            InitializeComponent();
        }

        private void FormFacturacion_Load(object sender, EventArgs e)
        {
            try
            {
                CargarClientes();
                CargarCategorias();
                CargarProductos();
                CargarDetalleVentaEnGrid();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error cargando datos: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void CargarClientes()
        {
            try
            {
                var clientes = clienteBL.Listar();
                if (clientes != null)
                {
                    var cmbClientes = this.Controls.Find("cmbClientes", true).FirstOrDefault() as ComboBox;
                    if (cmbClientes != null)
                    {
                        cmbClientes.DataSource = clientes;
                        cmbClientes.DisplayMember = "Nombre";
                        cmbClientes.ValueMember = "Id_Cliente";
                    }
                }
            }
            catch { }
        }

        private void CargarCategorias()
        {
            try
            {
                var categorias = categoriaBL.Listar();
                if (categorias != null)
                {
                    var cmbCategorias = this.Controls.Find("cmbCategorias", true).FirstOrDefault() as ComboBox;
                    if (cmbCategorias != null)
                    {
                        cmbCategorias.DataSource = categorias;
                        cmbCategorias.DisplayMember = "Nombre_Categoria";
                        cmbCategorias.ValueMember = "Id_Categoria";
                    }
                }
            }
            catch { }
        }

        private void CargarProductos()
        {
            try
            {
                var productos = productoBL.Listar();
                if (productos != null)
                {
                    List<Productos> listaProductos = new List<Productos>();
                    foreach (var p in productos)
                    {
                        listaProductos.Add(new Productos
                        {
                            id_productos = p.id_productos,
                            nombre_producto = p.nombre_producto,
                            precio_producto = p.precio_producto,
                            stock = p.stock,
                            id_categoria = p.id_categoria,
                            estado = p.estado
                        });
                    }

                    var cmbProductos = this.Controls.Find("cmbProductos", true).FirstOrDefault() as ComboBox;
                    if (cmbProductos != null)
                    {
                        cmbProductos.DataSource = listaProductos;
                        cmbProductos.DisplayMember = "nombre_producto";
                        cmbProductos.ValueMember = "id_productos";
                    }
                }
            }
            catch { }
        }

        private DataTable ObtenerDetalleVentaDesdeBD()
        {
            try
            {
                DetalleVentaBL detalleVentaBL = new DetalleVentaBL();
                return detalleVentaBL.ObtenerDetalleVentaConJoins();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error al obtener datos: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return new DataTable();
            }
        }

        private void CargarDetalleVentaEnGrid()
        {
            var dt = ObtenerDetalleVentaDesdeBD();
            dataGridView1.DataSource = dt;

            // Configurar ancho de columnas
            dataGridView1.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill;
            dataGridView1.SelectionMode = DataGridViewSelectionMode.FullRowSelect;

            // Ajustar ancho de columnas específicas
            if (dataGridView1.Columns.Contains("NombreProducto"))
                dataGridView1.Columns["NombreProducto"].Width = 150;
            if (dataGridView1.Columns.Contains("Categoria"))
                dataGridView1.Columns["Categoria"].Width = 80;
            if (dataGridView1.Columns.Contains("Cantidad"))
                dataGridView1.Columns["Cantidad"].Width = 80;
            if (dataGridView1.Columns.Contains("Precio"))
                dataGridView1.Columns["Precio"].Width = 100;
            if (dataGridView1.Columns.Contains("Subtotal"))
                dataGridView1.Columns["Subtotal"].Width = 100;
            if (dataGridView1.Columns.Contains("Total"))
                dataGridView1.Columns["Total"].Width = 100;
            if (dataGridView1.Columns.Contains("MetodoPago"))
                dataGridView1.Columns["MetodoPago"].Width = 120;
        }

        private void cmbProductos_SelectedIndexChanged(object sender, EventArgs e)
        {
            // Cuando se selecciona un producto, llenar automáticamente precio
            var cmbProductos = this.Controls.Find("cmbProductos", true).FirstOrDefault() as ComboBox;
            var txtPrecio = this.Controls.Find("txtPrecio", true).FirstOrDefault() as TextBox;
            var txtStock = this.Controls.Find("txtStock", true).FirstOrDefault() as TextBox;

            if (cmbProductos != null && cmbProductos.SelectedIndex != -1 && cmbProductos.SelectedItem is Productos prod)
            {
                if (txtPrecio != null)
                    txtPrecio.Text = prod.precio_producto.ToString();
                if (txtStock != null)
                    txtStock.Text = prod.stock.ToString();
            }
        }

        private void cmbCategorias_SelectedIndexChanged(object sender, EventArgs e)
        {
            // Filtrar productos por categoría seleccionada
            var cmbCategorias = this.Controls.Find("cmbCategorias", true).FirstOrDefault() as ComboBox;
            var cmbProductos = this.Controls.Find("cmbProductos", true).FirstOrDefault() as ComboBox;

            if (cmbCategorias != null && cmbCategorias.SelectedValue != null && cmbProductos != null)
            {
                int idCategoria = Convert.ToInt32(cmbCategorias.SelectedValue);
                var productos = productoBL.Listar();

                if (productos != null)
                {
                    List<Productos> productosFiltrados = new List<Productos>();
                    foreach (var p in productos)
                    {
                        if (p.id_categoria == idCategoria)
                        {
                            productosFiltrados.Add(new Productos
                            {
                                id_productos = p.id_productos,
                                nombre_producto = p.nombre_producto,
                                precio_producto = p.precio_producto,
                                stock = p.stock,
                                id_categoria = p.id_categoria,
                                estado = p.estado
                            });
                        }
                    }

                    cmbProductos.DataSource = productosFiltrados;
                    cmbProductos.DisplayMember = "nombre_producto";
                    cmbProductos.ValueMember = "id_productos";
                }
            }
        }

        private void reportViewer1_Load(object sender, EventArgs e)
        {
        }

        private void btnVerFactura_Click(object sender, EventArgs e)
        {
            try
            {
                // Validar que haya una fila seleccionada
                if (dataGridView1.SelectedRows.Count == 0)
                {
                    MessageBox.Show("Por favor, seleccione un producto para ver su factura.", "Validación", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                DataTable dt;
                if (dataGridView1.DataSource is DataTable)
                    dt = (DataTable)dataGridView1.DataSource;
                else
                    dt = ObtenerDetalleVentaDesdeBD();

                // Obtener datos de la fila seleccionada
                DataGridViewRow selectedRow = dataGridView1.SelectedRows[0];

                // Crear tabla con los datos del reporte
                DataTable dtReporte = new DataTable();
                dtReporte.Columns.Add("NombreProducto", typeof(string));
                dtReporte.Columns.Add("Categoria", typeof(string));
                dtReporte.Columns.Add("Cantidad", typeof(int));
                dtReporte.Columns.Add("Precio", typeof(decimal));
                dtReporte.Columns.Add("Subtotal", typeof(decimal));
                dtReporte.Columns.Add("Total", typeof(decimal));
                dtReporte.Columns.Add("MetodoPago", typeof(string));

                // Agregar la fila seleccionada
                dtReporte.Rows.Add(
                    selectedRow.Cells["NombreProducto"].Value,
                    selectedRow.Cells["Categoria"].Value,
                    selectedRow.Cells["Cantidad"].Value,
                    selectedRow.Cells["Precio"].Value,
                    selectedRow.Cells["Subtotal"].Value,
                    selectedRow.Cells["Total"].Value,
                    selectedRow.Cells["MetodoPago"].Value
                );

                // Abrir ventana emergente con el reporte
                FormVisualizarFactura formFactura = new FormVisualizarFactura(dtReporte, "Factura");
                formFactura.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error generando la factura: " + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnLimpiar_Click(object sender, EventArgs e)
        {
            var cmbClientes = this.Controls.Find("cmbClientes", true).FirstOrDefault() as ComboBox;
            var cmbCategorias = this.Controls.Find("cmbCategorias", true).FirstOrDefault() as ComboBox;
            var cmbProductos = this.Controls.Find("cmbProductos", true).FirstOrDefault() as ComboBox;
            var txtCantidad = this.Controls.Find("txtCantidad", true).FirstOrDefault() as TextBox;
            var txtPrecio = this.Controls.Find("txtPrecio", true).FirstOrDefault() as TextBox;
            var txtStock = this.Controls.Find("txtStock", true).FirstOrDefault() as TextBox;

            if (cmbClientes != null) cmbClientes.SelectedIndex = -1;
            if (cmbCategorias != null) cmbCategorias.SelectedIndex = -1;
            if (cmbProductos != null) cmbProductos.SelectedIndex = -1;
            if (txtCantidad != null) txtCantidad.Clear();
            if (txtPrecio != null) txtPrecio.Clear();
            if (txtStock != null) txtStock.Clear();
        }

        public void RefrescarDatos()
        {
            // Método público para refrescar los datos cuando se registra una nueva venta
            CargarDetalleVentaEnGrid();
        }
}
